name: Installation Tests

on:
  push:
    branches: [main]
    paths:
      - 'multi_mcp/**'
      - 'pyproject.toml'
      - '.github/workflows/install-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'multi_mcp/**'
      - 'pyproject.toml'
      - '.github/workflows/install-test.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Test PyPI installation (requires package to be published)'
        required: false
        default: false
        type: boolean

jobs:
  # Test installation from git clone (pip install .)
  test-git-install:
    name: Git Install - ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install package from source
      run: |
        python -m pip install --upgrade pip
        pip install .

    - name: Verify entry points exist (Unix)
      if: runner.os != 'Windows'
      run: |
        which multi
        which multi-server
        which multi-mcp

    - name: Verify entry points exist (Windows)
      if: runner.os == 'Windows'
      run: |
        where multi
        where multi-server
        where multi-mcp
      shell: cmd

    - name: Test CLI commands
      run: |
        multi --help
        multi-server --help
        multi-mcp --help

    - name: Test Python import
      run: |
        python -c "import multi_mcp; print(f'multi_mcp imported successfully')"
        python -c "from multi_mcp.server import mcp; print(f'FastMCP server: {mcp}')"
        python -c "from multi_mcp.cli import main; print('CLI main imported')"

    - name: Test package metadata
      run: |
        python -c "import importlib.metadata; v = importlib.metadata.version('multi-mcp'); print(f'Version: {v}')"

  # Test installation from PyPI (pip install multi-mcp)
  test-pypi-install:
    name: PyPI Install - ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    # Only run on release or manual trigger with test_pypi=true
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.test_pypi)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']

    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install package from PyPI
      run: |
        python -m pip install --upgrade pip
        pip install multi-mcp

    - name: Verify entry points exist (Unix)
      if: runner.os != 'Windows'
      run: |
        which multi
        which multi-server
        which multi-mcp

    - name: Verify entry points exist (Windows)
      if: runner.os == 'Windows'
      run: |
        where multi
        where multi-server
        where multi-mcp
      shell: cmd

    - name: Test CLI commands
      run: |
        multi --help
        multi-server --help
        multi-mcp --help

    - name: Test Python import
      run: |
        python -c "import multi_mcp; print(f'multi_mcp imported successfully')"
        python -c "from multi_mcp.server import mcp; print(f'FastMCP server: {mcp}')"
        python -c "from multi_mcp.cli import main; print('CLI main imported')"

    - name: Test package metadata
      run: |
        python -c "import importlib.metadata; v = importlib.metadata.version('multi-mcp'); print(f'Version: {v}')"

  # Test installation with uvx (recommended method for Claude Code users)
  test-uvx-install:
    name: uvx Install - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    # Only run on release or manual trigger with test_pypi=true
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.test_pypi)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Test uvx multi-mcp
      run: |
        uvx multi-mcp --help

  # Summary job for branch protection
  install-test-summary:
    name: Installation Tests Summary
    runs-on: ubuntu-latest
    needs: [test-git-install]
    if: always()
    steps:
    - name: Check results
      run: |
        if [ "${{ needs.test-git-install.result }}" != "success" ]; then
          echo "Git install tests failed"
          exit 1
        fi
        echo "All installation tests passed!"
